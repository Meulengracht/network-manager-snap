From ba8d280149cccfd24c7cbb78e8f301edaf4a0cfb Mon Sep 17 00:00:00 2001
From: Lukas MÃ¤rdian <slyon@ubuntu.com>
Date: Thu, 6 May 2021 15:05:33 +0200
Subject: [PATCH] netplan: use vendorized generate binary

---
 src/settings/plugins/keyfile/nms-keyfile-plugin.c |  4 ++--
 src/settings/plugins/keyfile/nms-keyfile-utils.c  | 14 ++++++++++++++
 src/settings/plugins/keyfile/nms-keyfile-utils.h  |  2 ++
 src/settings/plugins/keyfile/nms-keyfile-writer.c |  2 +-
 4 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/src/settings/plugins/keyfile/nms-keyfile-plugin.c b/src/settings/plugins/keyfile/nms-keyfile-plugin.c
index 548eda536..83bcdb857 100644
--- a/src/settings/plugins/keyfile/nms-keyfile-plugin.c
+++ b/src/settings/plugins/keyfile/nms-keyfile-plugin.c
@@ -561,7 +561,7 @@ reload_connections (NMSettingsPlugin *plugin,
 	nm_auto_clear_sett_util_storages NMSettUtilStorages storages_new = NM_SETT_UTIL_STORAGES_INIT (storages_new, nms_keyfile_storage_destroy);
 	int i;
 
-	netplan_generate(NULL);
+	_netplan_generate(NULL);
 	_fix_netplan_interface_name(NULL);
 	_load_dir (self, NMS_KEYFILE_STORAGE_TYPE_RUN, priv->dirname_run, &storages_new);
 	if (priv->dirname_etc)
@@ -1027,7 +1027,7 @@ delete_connection (NMSettingsPlugin *plugin,
 
 	g_autofree gchar* netplan_id = netplan_get_id_from_nm_filename(previous_filename, ssid);
 	netplan_delete_connection(netplan_id, NULL);
-	netplan_generate(NULL);
+	_netplan_generate(NULL);
 	_fix_netplan_interface_name(NULL);
 
 	_LOGT ("commit: deleted \"%s\", %s %s (%s%s%s%s)",
diff --git a/src/settings/plugins/keyfile/nms-keyfile-utils.c b/src/settings/plugins/keyfile/nms-keyfile-utils.c
index 44edabd37..e2030ec5c 100644
--- a/src/settings/plugins/keyfile/nms-keyfile-utils.c
+++ b/src/settings/plugins/keyfile/nms-keyfile-utils.c
@@ -407,3 +407,17 @@ nms_keyfile_utils_check_file_permissions (NMSKeyfileFiletype filetype,
 	NM_SET_OUT (out_st, st);
 	return TRUE;
 }
+
+gboolean
+_netplan_generate(const char* rootdir)
+{
+    /* Use 'netplan_generate()' from libnetplan once that is fixed to not be
+     * DENIED by apparmor via snapd's 'network-setup-control' interface.
+     * This needs https://github.com/snapcore/snapd/pull/10212 to be landed. */
+    const gchar *argv[] = { "/snap/network-manager/current/lib/netplan/generate", NULL , NULL, NULL };
+    if (rootdir) {
+        argv[1] = "--root-dir";
+        argv[2] = rootdir;
+    }
+    return g_spawn_sync(NULL, (gchar**)argv, NULL, 0, NULL, NULL, NULL, NULL, NULL, NULL);
+}
diff --git a/src/settings/plugins/keyfile/nms-keyfile-utils.h b/src/settings/plugins/keyfile/nms-keyfile-utils.h
index f9c298999..16b965ffd 100644
--- a/src/settings/plugins/keyfile/nms-keyfile-utils.h
+++ b/src/settings/plugins/keyfile/nms-keyfile-utils.h
@@ -73,4 +73,6 @@ gboolean nms_keyfile_utils_check_file_permissions (NMSKeyfileFiletype filetype,
                                                    struct stat *out_st,
                                                    GError **error);
 
+gboolean _netplan_generate(const char* rootdir);
+
 #endif /* __NMS_KEYFILE_UTILS_H__ */
diff --git a/src/settings/plugins/keyfile/nms-keyfile-writer.c b/src/settings/plugins/keyfile/nms-keyfile-writer.c
index 1bc761c4c..022eebce9 100644
--- a/src/settings/plugins/keyfile/nms-keyfile-writer.c
+++ b/src/settings/plugins/keyfile/nms-keyfile-writer.c
@@ -402,7 +402,7 @@ _internal_write_connection (NMConnection *connection,
 		 * we've written the /etc/netplan/*.yaml file instead. */
 		unlink(path);
 		g_free(path);
-		if (!netplan_generate(rootdir)) {
+		if (!_netplan_generate(rootdir)) {
 			g_set_error (error, NM_SETTINGS_ERROR, NM_SETTINGS_ERROR_FAILED,
 			             "netplan generate failed");
 			return FALSE;
-- 
2.32.0

